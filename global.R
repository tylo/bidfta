# global.R

library(rvest)
library(DT)
library(dplyr)
library(knitr)
#library(data.table)
library(rjson)
require(parallel)
require(urltools)

auto_refresh_time <- 3600 * 3
ending_soon_time <- 3600 * 2

# Some constants
time_file_format  <- "%Y-%m-%d %H:%M:%S"
wishlist_loc <- "CSV/wishlist.csv"
auctions_items_bar_split <- .5



######################################
#------------------------------------#
#------- HELPER FUNCTIONS -----------#
#------------------------------------#
######################################

######################################
#------ FUNCTION: GET_WISHLIST ------#
######################################
get_wishlist <- function() {

    read.csv(file = wishlist_loc,
             header = T,
             stringsAsFactors = F) %>%
        .[,1]
}

######################################
#------ FUNCTION: SAVE_WISHLIST -----#
######################################
save_wishlist <- function(tmp_wishlist) {

    tmp_wishlist %>%
        data.frame  %>%
        write.csv(file = wishlist_loc,
                  row.names = FALSE)
}

######################################
#------- FUNCTION: CLEAN_STR --------#
######################################

clean_str <- function(str) {
    str %>%
        gsub("[\t\n\r\v\f]", " ", .) %>%
        gsub(" +"," ",.) %>%
        gsub("^\\s+|\\s+$", "", .)
}

######################################
#--- FUNCTION: CLEAN_DESCRIPTION ----#
######################################
clean_description <- function(description) {
    description %>%
        gsub("(Additional Information|MSRP|Retail):.*", "", .) %>%
        gsub("(\t|\n|\r).*", "", .)
}

######################################
#------- FUNCTION: GEN_TITLE --------#
######################################
gen_title <- function(description, num_words=3) {
    gsub(".*Description: ","", description) %>%
        strsplit(" ") %>%
        sapply(function(x) x[1:num_words] %>% paste0(collapse = " ")  )

}


######################################
#----- FUNCTION: GEN_AMAZON_URL -----#
######################################
amazon_base <- "http://www.amazon.com/s/ref=nb_sb_noss?url=search-alias%3Daps&field-keywords="
gen_amazon_url <- function(description) {

    description %>%
        gsub("((Item)? ?Description|Brand): ?", " ", .) %>%
        clean_description %>%
        gsub("(\t|\n|\r).*", "", .) %>%
        gsub(" +", "+", .) %>%
        paste0(amazon_base, . )
}

######################################
#------ FUNCTION: GEN_GCAL_URL ------#
######################################
gcal_base <- "https://www.google.com/calendar/render?action=TEMPLATE&text=[description]&dates=[start]&details=[details]&location=[location]"
gen_gcal_url <- function(event_title, stime, description, loc="" ) {

    start_time <- (stime - 15*60) %>% strftime(format = "%Y%m%dT%H%M00Z", tz="UTC" )
    end_time <- stime %>% strftime(format = "%Y%m%dT%H%M00Z", tz="UTC")

    gcal_base %>%
        rep_len( length( event_title ) ) %>%
        param_set( "text", event_title ) %>%
        param_set( "dates", paste0( start_time,"/", end_time )) %>%
        param_set( "details", description ) %>%
        param_set( "location", loc ) %>% print
}


######################################
#--------- FUNCTION: GEN_PINS -------#
######################################
pin_html <-
'<div class="pin box box-info">
    <div class="box-header with-border">
        <h3 class="box-title">%s</h3></div>
    <div class="box-body">
        <a href="%s" target="_blank"><img src="%s"/></a>
        <p>%s</p></div>
    <div class="box-footer text-center no-padding">
        <div class="box-tools">
            <a href="%s" class="btn btn-box-tool" target="_blank"><i class="fa fa-amazon"></i></a>
            <a href="%s" class="btn btn-box-tool" target="_blank"><i class="fa fa-calendar-plus-o"></i></a>
        </div></div>
</div>'
gen_pins <- function( description, item_url, img_url,
                      auction_end="", location="") {


    title <- gen_title( description, 5) # short title for the pin
    amazon_url <- gen_amazon_url ( description ) # create amazon url
    gcal_url <- gen_gcal_url( paste("Bid:", title ) %>% url_encode,
                              auction_end , item_url )

    pin_html %>% sprintf( auction_end %>% strftime( format = "%a %r", tz="America/New_York"),
                          item_url, img_url,  description, amazon_url, gcal_url
    )

}


######################################
#-------- FUNCTION: RESCRAPE --------#
######################################

rescrape <- function( use.progress = T ) {

    # Create a Progress object
    if ( use.progress ) {
        progress <- shiny::Progress$new()
        progress$set(message = "Scraping ...", value = 0)
        on.exit(progress$close())

        # Progress call-back
        incrementProgress <- function(incr) {
            value <- progress$getValue()
            progress$set(value = value + incr)
        }
    }

    # Reading in home page
    link  <- read_html("http://bidfta.com/") %>%
        html_nodes(".auction")  %>%
        html_node("a") %>%
        html_attr("href")

    ##########################################################
    ##### THIS STUFF SHOULD GO IN A VALIDATOR FUNCTION #######
    # Filter out links on other auction sites
    fix_these  <- grep("mnlist",link)

    link[fix_these] <- link[fix_these] %>%
        gsub("mnlist","mndetails",.) %>%
        sub("/category/ALL","",.)


    # Filter out blank links
    link <- link[link != '']

    # Filter out links on other auction sites
    bidfta_hosted <- grepl("bidfta", link, ignore.case = T)

    "total links found" %>% cat(link %>% length,.,"\n")
    "external auctions removed\n" %>% cat((!bidfta_hosted) %>% sum, .)
    link <- link[bidfta_hosted]


    ##### END LINK VALIDATION ################################
    ##########################################################


    # Time the 1st retrieval
    "|----- GETTING AUCTIONS -----|" %>% cat("\n",., "\n\n")
    if ( use.progress ) progress$set(detail = "Fetching auction list", value=0)
    auctions_incr <- auctions_items_bar_split/length(link)
    ptm <- proc.time()
    auctions <- link %>%
        #.[40:60] %>%
        lapply( auction_details, auctions_incr, if(use.progress) incrementProgress else NULL )

    # Report how many null auctions
    auctions %>% sapply(is.null) %>% sum %>% cat("\n",.,"expired or invalid auctions removed\n")

    auctions <- auctions %>%
        #mclapply(auction_details, mc.preschedule = F, mc.cores = 4) %>%  #trying multithreaded
        .[!sapply(.,is.null)]

    auctions_df <- auctions %>%
        lapply(data.frame, stringsAsFactors = FALSE) %>%
        do.call(rbind, .)


    #Output time to shell
    print(proc.time() - ptm)



    #Cleaning locations and eliminating out-of-towners
    auctions_df$location <- auctions_df$location %>% gsub(" \\d{5}.*","",., ignore.case = T)
    auctions_df$location %>% table %>% data.frame %>% arrange(desc(Freq)) %>% print

    # Good locations
    good_loc  <- c("Cincinnati", "Sharonville", "West Chester") %>%
        sapply(function(x) grepl(x, auctions_df$location, ignore.case = T)) %>%
        apply(1, any)



    # Report how many auctions in different locations
    (good_loc) %>% sum %>% cat("\n",.,"local auctions\n")
    (!good_loc) %>% sum %>% cat("out-of-town auctions removed\n")

    auctions_df <- filter(auctions_df, good_loc)

    # Get Items
    "|----- GETTING ITEMS -----|" %>%  cat("\n",., "\n")
    ptm <- proc.time()

    if ( use.progress ) progress$set(detail = "Fetching auction items", value = auctions_items_bar_split)
    items_incr <- (1 - auctions_items_bar_split)/length(auctions_df$link)
    items <- auctions_df$link %>%
        #mclapply(get_itemslist, mc.cores = 6)
        lapply( get_itemlist, items_incr, if( use.progress ) incrementProgress else NULL )
    names(items) <- auctions_df$title

    #Output time to shell
    print(proc.time() - ptm)

    items_df <- items %>%
        do.call( rbind, . ) %>%
        mutate( Auction = gsub("\\.[0-9]+","", row.names(.)) )

    # Add new timestamp
    data.frame( time = Sys.time(), method = ifelse( use.progress, "browser", "cron" ) ) %>%
        write.table( "CSV/timestamp.csv", append = T, sep = ",", row.names = F )

    write.csv(auctions_df, "CSV/auctions.csv", row.names = F)
    write.csv(items_df, "CSV/items.csv", row.names = F)
}

######################################
#----- FUNCTION: AUCTION_DETAILS ----#
######################################

# Pulls auction details from an auction description page link
auction_details  <- function(link, incr, progress_updater = NULL) {
    if( !is.null( progress_updater )) progress_updater(incr)
    a  <- list()
    tmp <- read_html(link) %>%
        html_nodes("table tr td")

    cat(link)
    try(a$date  <- tmp[[6]] %>%
            html_text %>%
            gsub("\\.", ",", .) %>%
            gsub("(\\d+)(st|nd|rd|th)","\\1", .) %>%
            strptime("%B %e, %Y %I:%M %p", tz = 'EST5EDT')
    )

    #print(class(a$date))
    try(
        if (is.null(a$date) ) {
            cat (" | no date\n")
            return(NULL)
        }
        else if ( is.na(a$date) ){
            cat (" | no date\n")
            return(NULL)
        }
        else if (a$date - Sys.time() < 0 ) {
            cat (" | expired\n")
            return(NULL)
        }
        else {
            a$date %>% format(usetz = T) %>% cat(" | ", . ,"\n")
        }
    )

    a$title  <- tmp %>%
        html_nodes("#auction_title") %>%
        .[[1]] %>%
        html_text

    # 8th entry / row in table contains auction location
    a$location  <- tmp[[8]] %>%
        html_text %>%
        clean_str

    a$link  <- link %>%
        gsub("mndetails","mnlist",.) %>%
        paste0("/category/ALL")
    #cat("OK\n")
    a
}

######################################
#----- FUNCTION: GET_ITEMSLIST ------#
######################################

# Pulls item lists from an auction item list link
get_itemlist  <- function(lnk, incr, progress_updater = NULL) {

    if( !is.null( progress_updater )) progress_updater(incr)
    lnk %>% cat("\n", .)

    root_link <- lnk %>%
        gsub("category/ALL","", .)

    itemlist <- root_link %>%
        gsub("mnlist", "mnprint", .) %>%
        read_html %>%
        html_node("#DataTable") %>%
        html_table(header = T, fill = T) %>%
        mutate( Item = gsub("[.]","", Item),
                Description = iconv(Description, to = 'UTF-8', sub = ' ')) %>%
        mutate(link = paste0(root_link, Item))

    cat(" |","itemlist ok")
    #itemlist %>%  print

    n <- nrow(itemlist) - 1

    try(img_link <- itemlist$link %>%
            .[n] %>%
            read_html %>%
            html_node("#DataTable") %>%
            html_node("img") %>%
            html_attr("src"))

    cat(" |","img_link ok")

    try(img_prefix <- img_link %>%
            gsub("/[^/]+$","/",.))

    try(img_suffix <- img_link %>%
            regexpr("\\.\\w+$",.) %>%
            regmatches(img_link, .))

    try(img_suffix <- img_link %>%
            gsub(paste0(img_prefix, itemlist$Item[n]), "", .))

    try(itemlist %>%
            mutate(img_src = paste0(img_prefix, Item, img_suffix)))

}
